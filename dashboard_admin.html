<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Administrador - Inventario Maestro</title>
  <link rel="stylesheet" href="./css/dashboard.css" />
  <style>
    body { background: #101820; color: #e4e4e4; font-family: "Poppins", sans-serif; }
    .topbar { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #0d2538; }
    .btn { background: #00b4d8; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; color: white; margin: 2px; }
    .btn:hover { background: #0096c7; }
    .card { background: #162d3f; border-radius: 10px; padding: 1rem; margin: 1rem auto; width: 95%; max-width: 1000px; box-shadow: 0 0 10px #0004; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #223b52; padding: 8px; text-align: center; }
    th { background: #1f3a53; color: #00b4d8; }
    tr:hover { background: #23384b; }
    input, select { padding: 6px; border-radius: 6px; border: 1px solid #333; background: #14293d; color: white; }
  </style>
</head>
<body>
  <header class="topbar">
    <img src="./img/logo.png" class="logo" alt="logo" />
    <h1>Panel Administrador</h1>
    <button id="logoutBtn" class="btn">Cerrar sesi√≥n</button>
  </header>

  <main class="container">

    <!-- INVENTARIO -->
    <section class="card">
      <h2>Inventario</h2>
      <form id="formProducto">
        <input id="codigo" placeholder="C√≥digo" required />
        <input id="nombre" placeholder="Nombre" required />
        <input id="cantidad" type="number" placeholder="Cantidad" min="1" required />
        <input id="precioCompra" type="number" placeholder="Compra" min="1" required />
        <input id="precioVenta" type="number" placeholder="Venta" min="1" required />
        <button class="btn" type="submit">Guardar</button>
      </form>

      <div style="margin-top:10px;">
        <button id="exportInventario" class="btn">üì¶ Exportar Inventario</button>
        <input type="file" id="importFile" accept=".csv" style="display:none;">
        <button id="importInventario" class="btn" style="background:#007f5f;">üì§ Importar Inventario</button>
      </div>

      <table id="tablaProductos">
        <thead>
          <tr>
            <th>C√≥digo</th><th>Nombre</th><th>Cant.</th>
            <th>Compra</th><th>Venta</th><th>Ganancia</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- USUARIOS -->
    <section class="card">
      <h2>Usuarios</h2>
      <form id="formUsuario">
        <input id="usuario" placeholder="Usuario" required />
        <input id="clave" type="password" placeholder="Contrase√±a" required />
        <select id="rol">
          <option value="cajero">Cajero</option>
          <option value="inventarista">Inventarista</option>
          <option value="administrador">Administrador</option>
        </select>
        <button class="btn" type="submit">Crear Usuario</button>
      </form>

      <table id="tablaUsuarios">
        <thead>
          <tr><th>Usuario</th><th>Rol</th><th>Acciones</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- VENTAS -->
    <section class="card">
      <h2>Ventas Registradas</h2>
      <div style="margin-bottom:10px;">
        <button id="exportVentas" class="btn">üì• Exportar Ventas</button>
      </div>
      <table id="tablaVentas">
        <thead>
          <tr>
            <th>Fecha</th><th>Cajero</th><th>Cliente</th><th>Subtotal</th><th>Desc.</th><th>IVA</th><th>Total</th><th>Estado</th><th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="resumen">
        <h3>Resumen</h3>
        <p>Total Ventas: <b id="totalVentas">$0</b></p>
        <p>Ventas Anuladas: <b id="ventasAnuladas">0</b></p>
      </div>
    </section>
  </main>

  <footer class="foot"><small>¬© 2025 Inventario Maestro</small></footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, doc, addDoc, deleteDoc, updateDoc, getDoc, getDocs, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyByhD4vM7DCjjIOBoaUuLH_wRh93DcRdkw",
      authDomain: "inventario-b4431.firebaseapp.com",
      projectId: "inventario-b4431",
      storageBucket: "inventario-b4431.firebasestorage.app",
      messagingSenderId: "229641140897",
      appId: "1:229641140897:web:c1ac156045b0edbf110ee0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const sesion = JSON.parse(localStorage.getItem("sesion_negocio") || "{}");
    if (!sesion.id) {
      alert("Inicia sesi√≥n primero");
      location.href = "./login.html";
    }

    const formatoCOP = n => new Intl.NumberFormat("es-CO", { style: "currency", currency: "COP" }).format(n || 0);

    /* ---------------- INVENTARIO ---------------- */
    const refProductos = collection(db, `negocios/${sesion.id}/productos`);
    const tbodyProd = document.querySelector("#tablaProductos tbody");

    onSnapshot(refProductos, snap => {
      tbodyProd.innerHTML = "";
      snap.forEach(docu => {
        const p = docu.data();
        const ganancia = (p.precioVenta || 0) - (p.precioCompra || 0);
        const tr = document.createElement("tr");
        if (p.cantidad <= 5) tr.style.background = "#742a2a"; // bajo stock alerta
        tr.innerHTML = `
          <td>${p.codigo}</td>
          <td>${p.nombre}</td>
          <td>${p.cantidad}</td>
          <td>${formatoCOP(p.precioCompra)}</td>
          <td>${formatoCOP(p.precioVenta)}</td>
          <td>${formatoCOP(ganancia)}</td>
          <td>
            <button class="btn editar" data-id="${docu.id}">‚úèÔ∏è</button>
            <button class="btn borrar" data-id="${docu.id}" style="background:#e63946;">üóë</button>
          </td>`;
        tbodyProd.appendChild(tr);
      });

      document.querySelectorAll(".borrar").forEach(b =>
        b.onclick = async () => {
          if (confirm("¬øEliminar producto?"))
            await deleteDoc(doc(db, `negocios/${sesion.id}/productos/${b.dataset.id}`));
        }
      );

      document.querySelectorAll(".editar").forEach(btn =>
        btn.onclick = async () => {
          const id = btn.dataset.id;
          const snap = await getDoc(doc(db, `negocios/${sesion.id}/productos/${id}`));
          const p = snap.data();
          const nuevoNombre = prompt("Nuevo nombre:", p.nombre);
          const nuevoCompra = parseFloat(prompt("Nuevo precio de compra:", p.precioCompra));
          const nuevoVenta = parseFloat(prompt("Nuevo precio de venta:", p.precioVenta));
          const nuevaCant = parseInt(prompt("Nueva cantidad:", p.cantidad));
          if (!nuevoNombre || isNaN(nuevoVenta)) return;
          await updateDoc(doc(db, `negocios/${sesion.id}/productos/${id}`), {
            nombre: nuevoNombre, precioCompra: nuevoCompra, precioVenta: nuevoVenta, cantidad: nuevaCant
          });
        }
      );
    });

    document.getElementById("formProducto").onsubmit = async e => {
      e.preventDefault();
      const p = {
        codigo: codigo.value.trim(),
        nombre: nombre.value.trim(),
        cantidad: parseInt(cantidad.value),
        precioCompra: parseFloat(precioCompra.value),
        precioVenta: parseFloat(precioVenta.value)
      };
      await addDoc(refProductos, p);
      e.target.reset();
    };

    /* ---------------- IMPORTAR INVENTARIO ---------------- */
    document.getElementById("importInventario").onclick = () => {
      document.getElementById("importFile").click();
    };

    document.getElementById("importFile").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (evt) => {
        const text = evt.target.result;
        const filas = text.split("\n").map(f => f.trim()).filter(f => f.length);
        const headers = filas[0].split(",");
        const productos = filas.slice(1).map(row => {
          const valores = row.split(",");
          const obj = {};
          headers.forEach((h, i) => obj[h.trim()] = valores[i]?.trim());
          return obj;
        });

        let actualizados = 0, nuevos = 0;
        for (const p of productos) {
          if (!p.codigo || !p.nombre) continue;
          const q = query(refProductos, where("codigo", "==", p.codigo));
          const snap = await getDocs(q);
          const data = {
            codigo: p.codigo,
            nombre: p.nombre,
            cantidad: parseInt(p.cantidad || 0),
            precioCompra: parseFloat(p.compra || 0),
            precioVenta: parseFloat(p.venta || 0)
          };
          if (!snap.empty) {
            await updateDoc(doc(db, `negocios/${sesion.id}/productos/${snap.docs[0].id}`), data);
            actualizados++;
          } else {
            await addDoc(refProductos, data);
            nuevos++;
          }
        }

        alert(`‚úÖ Importaci√≥n completada.\nProductos nuevos: ${nuevos}\nActualizados: ${actualizados}`);
      };
      reader.readAsText(file);
    });

    /* ---------------- USUARIOS ---------------- */
    const refNegocio = doc(db, "negocios", sesion.id);
    const tbodyUser = document.querySelector("#tablaUsuarios tbody");

    async function cargarUsuarios() {
      const snap = await getDoc(refNegocio);
      const data = snap.data();
      tbodyUser.innerHTML = "";
      (data.usuarios || []).forEach((u, i) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.usuario}</td><td>${u.rol}</td>
          <td><button class="btn borrarUser" data-index="${i}" style="background:#e63946;">üóë</button></td>`;
        tbodyUser.appendChild(tr);
      });

      document.querySelectorAll(".borrarUser").forEach(b =>
        b.onclick = async () => {
          if (!confirm("¬øEliminar este usuario?")) return;
          const snap = await getDoc(refNegocio);
          const data = snap.data();
          data.usuarios.splice(b.dataset.index, 1);
          await updateDoc(refNegocio, { usuarios: data.usuarios });
          cargarUsuarios();
        }
      );
    }

    document.getElementById("formUsuario").onsubmit = async e => {
      e.preventDefault();
      const snap = await getDoc(refNegocio);
      const data = snap.data();
      const usuarios = data.usuarios || [];
      usuarios.push({
        usuario: usuario.value.trim(),
        passwordHash: clave.value.trim(),
        rol: rol.value
      });
      await updateDoc(refNegocio, { usuarios });
      e.target.reset();
      cargarUsuarios();
    };

    cargarUsuarios();

    /* ---------------- VENTAS ---------------- */
    const refVentas = collection(db, `negocios/${sesion.id}/ventas`);
    const tbodyVentas = document.querySelector("#tablaVentas tbody");

    onSnapshot(refVentas, snap => {
      tbodyVentas.innerHTML = "";
      let total = 0, anuladas = 0;
      snap.forEach(d => {
        const v = d.data();
        const fecha = v.fecha ? new Date(v.fecha) : new Date();
        if (v.estado === "anulada") anuladas++;
        else total += v.totalFinal || v.total || 0;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${fecha.toLocaleString()}</td>
          <td>${v.cajero || "(sin cajero)"}</td>
          <td>${v.cliente?.nombre || "-"}</td>
          <td>${formatoCOP(v.subtotal || 0)}</td>
          <td>${v.descuento || 0}%</td>
          <td>${v.iva || 0}%</td>
          <td>${formatoCOP(v.totalFinal || v.total || 0)}</td>
          <td>${v.estado || "activa"}</td>
          <td>${v.estado === "activa" ? `<button class="btn anular" data-id="${d.id}" style="background:#e63946;">‚ùå</button>` : "-"}</td>`;
        tbodyVentas.appendChild(tr);
      });

      document.getElementById("totalVentas").textContent = formatoCOP(total);
      document.getElementById("ventasAnuladas").textContent = anuladas;

      document.querySelectorAll(".anular").forEach(btn =>
        btn.onclick = async () => {
          if (confirm("¬øAnular esta venta?"))
            await updateDoc(doc(db, `negocios/${sesion.id}/ventas/${btn.dataset.id}`), { estado: "anulada" });
        }
      );
    });

    /* ---------------- EXPORTAR CSV ---------------- */
    function exportarCSV(nombre, datos) {
      const encabezados = Object.keys(datos[0]).join(",");
      const filas = datos.map(d => Object.values(d).join(",")).join("\n");
      const csv = encabezados + "\n" + filas;
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${nombre}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById("exportVentas").onclick = async () => {
      const snap = await getDocs(refVentas);
      const datos = [];
      snap.forEach(v => {
        const d = v.data();
        datos.push({
          fecha: new Date(d.fecha).toLocaleString(),
          cajero: d.cajero,
          cliente: d.cliente?.nombre || "",
          subtotal: d.subtotal || 0,
          descuento: d.descuento || 0,
          iva: d.iva || 0,
          total: d.totalFinal || d.total || 0,
          estado: d.estado
        });
      });
      exportarCSV("ventas", datos);
    };

    document.getElementById("exportInventario").onclick = async () => {
      const snap = await getDocs(refProductos);
      const datos = [];
      snap.forEach(p => {
        const d = p.data();
        datos.push({
          codigo: d.codigo,
          nombre: d.nombre,
          cantidad: d.cantidad,
          compra: d.precioCompra,
          venta: d.precioVenta,
          ganancia: (d.precioVenta - d.precioCompra)
        });
      });
      exportarCSV("inventario", datos);
    };

    /* ---------------- LOGOUT ---------------- */
    logoutBtn.onclick = () => {
      localStorage.clear();
      location.href = "./login.html";
    };
  </script>
</body>
</html>
