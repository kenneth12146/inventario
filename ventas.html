<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Cajero</title>
  <link rel="stylesheet" href="./css/ventas.css" />
</head>
<body>
  <header class="topbar">
    <img src="./img/logo.png" class="logo" />
    <h1>Punto de Venta (Cajero)</h1>
    <button id="logoutBtn" class="btn">Cerrar sesiÃ³n</button>
  </header>

  <main class="container">
    <!-- SCANNER -->
    <section class="card">
      <h2>Buscar o escanear producto</h2>
      <input id="buscar" placeholder="CÃ³digo o nombre del producto" autofocus />
      <button id="btnBuscar" class="btn">Buscar</button>
      <button id="btnCamara" class="btn">ğŸ“· Escanear</button>
      <div id="previewCamara" style="display:none;">
        <video id="video" autoplay></video>
      </div>
    </section>

    <!-- CARRITO -->
    <section class="card">
      <h2>Carrito de Venta</h2>
      <table id="tablaCarrito">
        <thead>
          <tr>
            <th>Producto</th><th>Cantidad</th><th>Precio</th><th>Subtotal</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p>Total: <b id="total">0</b></p>
      <button id="btnConfirmar" class="btn">ğŸ’¾ Registrar Venta</button>
      <button id="btnCancelar" class="btn">âŒ Cancelar</button>
    </section>

    <!-- HISTORIAL -->
    <section class="card">
      <h2>Ãšltimas Ventas</h2>
      <table id="tablaVentas">
        <thead>
          <tr><th>Fecha</th><th>Total</th><th>Estado</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer class="foot"><small>Â© 2025 Inventario Maestro</small></footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, updateDoc,
      doc, getDoc, onSnapshot, Timestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyByhD4vM7DCjjIOBoaUuLH_wRh93DcRdkw",
      authDomain: "inventario-b4431.firebaseapp.com",
      projectId: "inventario-b4431",
      storageBucket: "inventario-b4431.firebasestorage.app",
      messagingSenderId: "229641140897",
      appId: "1:229641140897:web:c1ac156045b0edbf110ee0",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const sesion = JSON.parse(localStorage.getItem("sesion_negocio") || "{}");
    const user = JSON.parse(localStorage.getItem("usuario_actual") || "{}");

    if (!sesion.id || !user.usuario) {
      alert("Inicia sesiÃ³n primero");
      location.href = "./login.html";
    }

    const refProductos = collection(db, `negocios/${sesion.id}/productos`);
    const refVentas = collection(db, `negocios/${sesion.id}/ventas`);

    const tbody = document.querySelector("#tablaCarrito tbody");
    const totalElem = document.getElementById("total");
    const buscar = document.getElementById("buscar");
    let carrito = [];

    /* ---------------- BUSCAR PRODUCTO ---------------- */
    async function buscarProducto() {
      const texto = buscar.value.trim().toLowerCase();
      if (!texto) return;
      const snap = await getDocs(refProductos);
      let encontrado = null;
      snap.forEach(docu => {
        const p = docu.data();
        if (p.codigo.toLowerCase() === texto || p.nombre.toLowerCase().includes(texto))
          encontrado = { id: docu.id, ...p };
      });
      if (encontrado) agregarCarrito(encontrado);
      else alert("Producto no encontrado");
      buscar.value = "";
    }

    document.getElementById("btnBuscar").onclick = buscarProducto;
    buscar.onkeydown = e => e.key === "Enter" && buscarProducto();

    /* ---------------- CARRITO ---------------- */
    function renderCarrito() {
      tbody.innerHTML = "";
      let total = 0;
      carrito.forEach((p, i) => {
        const subtotal = p.cantidad * p.precioVenta;
        total += subtotal;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.nombre}</td>
          <td><input type="number" value="${p.cantidad}" min="1" data-index="${i}" class="cantInput"></td>
          <td>${p.precioVenta}</td>
          <td>${subtotal}</td>
          <td><button class="btn quitar" data-index="${i}">ğŸ—‘</button></td>
        `;
        tbody.appendChild(tr);
      });
      totalElem.textContent = total.toLocaleString("es-CO", { style: "currency", currency: "COP" });

      document.querySelectorAll(".cantInput").forEach(inp =>
        inp.addEventListener("change", e => {
          carrito[e.target.dataset.index].cantidad = parseInt(e.target.value);
          renderCarrito();
        })
      );

      document.querySelectorAll(".quitar").forEach(btn =>
        btn.addEventListener("click", e => {
          carrito.splice(e.target.dataset.index, 1);
          renderCarrito();
        })
      );
    }

    function agregarCarrito(prod) {
      const existente = carrito.find(p => p.id === prod.id);
      if (existente) existente.cantidad++;
      else carrito.push({ ...prod, cantidad: 1 });
      renderCarrito();
    }

    /* ---------------- REGISTRAR VENTA ---------------- */
    document.getElementById("btnConfirmar").onclick = async () => {
      if (carrito.length === 0) return alert("Carrito vacÃ­o");
      const total = carrito.reduce((t, p) => t + p.precioVenta * p.cantidad, 0);
      const venta = {
        fecha: Timestamp.now(),
        cajero: user.usuario,
        total,
        productos: carrito.map(p => ({
          codigo: p.codigo,
          nombre: p.nombre,
          cantidad: p.cantidad,
          precioVenta: p.precioVenta
        })),
        estado: "activa",
      };
      await addDoc(refVentas, venta);
      carrito = [];
      renderCarrito();
      alert("Venta registrada");
    };

    document.getElementById("btnCancelar").onclick = () => {
      if (confirm("Â¿Cancelar venta actual?")) {
        carrito = [];
        renderCarrito();
      }
    };

    /* ---------------- HISTORIAL ---------------- */
    const tbodyVentas = document.querySelector("#tablaVentas tbody");
    onSnapshot(refVentas, snap => {
      tbodyVentas.innerHTML = "";
      snap.forEach(d => {
        const v = d.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${new Date(v.fecha.seconds * 1000).toLocaleString()}</td>
          <td>${v.total.toLocaleString("es-CO", { style: "currency", currency: "COP" })}</td>
          <td>${v.estado}</td>
        `;
        tbodyVentas.appendChild(tr);
      });
    });

    /* ---------------- ESCÃNER CON CÃMARA ---------------- */
    const video = document.getElementById("video");
    const preview = document.getElementById("previewCamara");
    let stream = null;

    document.getElementById("btnCamara").onclick = async () => {
      if (preview.style.display === "none") {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
        preview.style.display = "block";
      } else {
        stream?.getTracks().forEach(t => t.stop());
        preview.style.display = "none";
      }
    };

    /* ---------------- LOGOUT ---------------- */
    logoutBtn.onclick = () => {
      localStorage.clear();
      location.href = "./login.html";
    };
  </script>
</body>
</html>
